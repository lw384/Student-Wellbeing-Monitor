name: Tests & Coverage

on:
    push:
        branches: [main, dev]
    pull_request:

# GitHub Pages 需要这些权限
permissions:
    contents: read
    pages: write
    id-token: write

jobs:
    test-and-coverage:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install Poetry
              run: pip install poetry

            - name: Install dependencies
              run: poetry install --no-interaction

            - name: Run tests with coverage
              run: |
                  poetry run coverage run -m pytest
                  poetry run coverage xml
                  poetry run coverage html

            - name: Upload coverage.xml as artifact
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-xml
                  path: coverage.xml

            # 把 htmlcov/ 作为 GitHub Pages 的构建产物上传
            - name: Upload coverage HTML to GitHub Pages artifact
              if: github.ref == 'refs/heads/main'
              uses: actions/upload-pages-artifact@v3
              with:
                  path: htmlcov

    deploy-pages:
        # 只在 main 分支上部署
        if: github.ref == 'refs/heads/main'
        needs: test-and-coverage
        runs-on: ubuntu-latest
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        permissions:
            pages: write
            id-token: write

        steps:
            - name: Deploy GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
