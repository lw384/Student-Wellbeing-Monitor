{% extends "layout.html" %}
{% set active_page = 'dashboard' %}
{% set simple_layout = False %}

{% block content %}
<div class="main-content">

  {# ==== title ==== #}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="page-title mb-1">
        {% if role == "wellbeing" %}
        Wellbeing Officer Dashboard
        {% else %}
        Course Director Dashboard
        {% endif %}
      </h1>
      <p class="page-subtitle mb-0">
        {% if role == "wellbeing" %}
        Monitor trends in stress, sleep and engagement over recent weeks.
        {% else %}
        Course Director Dashboard
        {% endif %}

      </p>
    </div>

    <div class="text-end d-none d-md-block">
      <a href="{{ url_for('view_data', role=role) }}" class="link-muted d-block">
        View data tables →
      </a>
    </div>
  </div>
  {# ==== filter: Week + Programme (+ Module for course_leader) ==== #}
  <div class="card-elevated mb-3">
    <form class="d-flex flex-wrap align-items-end gap-3" method="get" action="{{ url_for('dashboard', role=role) }}">

      <style>
        .filter-field {
          width: 180px;
        }
      </style>

      {# ---- Start Week ---- #}
      <div class="filter-field">
        <label class="form-label fw-semibold small text-uppercase text-muted mb-1">
          Start Week
        </label>
        <select name="start_week" class="form-select form-select-sm">
          {% for w in weeks %}
          <option value="{{ w }}" {% if w==current_start_week %}selected{% endif %}>
            Week {{ w }}
          </option>
          {% endfor %}
        </select>
      </div>

      {# ---- End Week ---- #}
      <div class="filter-field">
        <label class="form-label fw-semibold small text-uppercase text-muted mb-1">
          End Week
        </label>
        <select name="end_week" class="form-select form-select-sm">
          {% for w in weeks %}
          <option value="{{ w }}" {% if w==current_end_week %}selected{% endif %}>
            Week {{ w }}
          </option>
          {% endfor %}
        </select>
      </div>

      {# ---- Programme ---- #}
      <div class="filter-field">
        <label class="form-label fw-semibold small text-uppercase text-muted mb-1">
          Programme
        </label>
        <select id="programme-select" name="programme_id" class="form-select form-select-sm" {% if role=='course_leader'
          %}required{% endif %}>

          {# wellbeing 可以选全部 #}
          {% if role == 'wellbeing' %}
          <option value="">All programmes</option>

          {% endif %}

          {% for p in programmes %}
          <option value="{{ p.id }}" {% if p.id==current_programme %}selected{% endif %}>
            {{ p.code }} – {{ p.name }}
          </option>
          {% endfor %}
        </select>
      </div>

      {# ---- Module 仅在 course_leader 角色时显示 ---- #}
      {% if role == 'course_leader' %}
      <div class="filter-field">
        <label class="form-label fw-semibold small text-uppercase text-muted mb-1">
          Module
        </label>

        {# ======== Disable until programme selected ======== #}
        <select id="module-select" name="module_id" class="form-select form-select-sm" {% if not current_programme
          %}disabled{% endif %}>

          {% if current_programme %}
          {# ------ programme selected → show All modules ------ #}
          <option value="" {% if not current_module %}selected{% endif %}>
            All modules
          </option>

          {% for m in modules %}
          <option value="{{ m.id }}" {% if m.id==current_module %}selected{% endif %}>
            {{ m.code }} – {{ m.name }}
          </option>
          {% endfor %}

          {% else %}
          {# ------ programme NOT selected → show placeholder ------ #}
          <option value="">Select programme first</option>
          {% endif %}

        </select>
      </div>
      {% endif %}

      {# ---- Apply button ---- #}
      <div class="ms-auto">
        <button type="submit" class="btn btn-primary btn-sm px-4">
          Apply
        </button>
      </div>

    </form>
  </div>
  {# ==== index card: based on roles ==== #}
  {% if role == 'wellbeing' %}

  {# ------- Student Wellbeing Officer ------- #}
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <div class="card-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-uppercase text-muted fw-semibold">
            Avg Hours Slept
          </span>
        </div>
        <div class="d-flex align-items-baseline gap-2">
          <span class="fs-3 fw-semibold">
            {{ summary.avg_sleep|default('--') }}
          </span>
          <span class="text-muted small">hrs / night</span>
        </div>
        <p class="text-muted small mb-0 mt-1">
          Based on selected week & programme.
        </p>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-uppercase text-muted fw-semibold">
            Avg Stress Level
          </span>
        </div>
        <div class="d-flex align-items-baseline gap-2">
          <span class="fs-3 fw-semibold">
            {{ summary.avg_stress|default('--') }}
          </span>
          <span class="text-muted small">/ 5</span>
        </div>
        <p class="text-muted small mb-0 mt-1">
          Higher values may indicate wellbeing risk.
        </p>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-uppercase text-muted fw-semibold">
            Survey Responses
          </span>
        </div>
        <div class="d-flex align-items-baseline gap-2">
          <span class="fs-3 fw-semibold">
            {{ summary.response_count|default('--') }}
          </span>
          <span class="text-muted small">students</span>
        </div>
        <p class="text-muted small mb-0 mt-1">
          Response rate {{ summary.response_rate|default('--') }}%.
        </p>
      </div>
    </div>
  </div>

  {% elif role == 'course_leader' %}

  {# ------- Course Leader ------- #}
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <div class="card-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-uppercase text-muted fw-semibold">
            Avg Attendance Rate
          </span>
        </div>
        <div class="d-flex align-items-baseline gap-2">
          <span class="fs-3 fw-semibold">
            {{ ((summary.avg_attendance_rate or 0) * 100)|round(1) }}
          </span>
          <span class="text-muted small">%</span>
        </div>
        <p class="text-muted small mb-0 mt-1">
          Across selected weeks & modules.
        </p>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-uppercase text-muted fw-semibold">
            Avg Submission Rate
          </span>
        </div>
        <div class="d-flex align-items-baseline gap-2">
          <span class="fs-3 fw-semibold">
          {{ ((summary.avg_submission_rate or 0) * 100) | round(1) }}
          </span>
          <span class="text-muted small">%</span>
        </div>
        <p class="text-muted small mb-0 mt-1">
          Proportion of submitted assignments.
        </p>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-uppercase text-muted fw-semibold">
            Avg Grade
          </span>
        </div>
        <div class="d-flex align-items-baseline gap-2">
          <span class="fs-3 fw-semibold">
            {{ (summary.avg_grade or 0) | round(1) }}
          </span>
          <span class="text-muted small">/ 100</span>
        </div>
        <p class="text-muted small mb-0 mt-1">
          Based on submitted assignments only.
        </p>
      </div>
    </div>
  </div>

  {% endif %}

  {# ==== line chart: trend across week(stress/sleep/response) ==== #}
  {% if role == 'wellbeing' %}
  <div class="card-elevated mb-3">
    <h6 class="mb-0">Stress & Sleep over weeks</h6>
    <div style="height: 320px;">
      <canvas id="lineChartWellbeing"></canvas>
    </div>
  </div>
  {% endif %}
  {% if role == 'course_leader' %}
  <div class="card-elevated mb-3">
    <h6 class="mb-0">Attendance Trend over Weeks</h6>
    <div style="height: 320px;">
      <canvas id="lineChartCourse"></canvas>
    </div>
  </div>

  <div class="card-elevated mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0">Submissions by Module</h6>
      <span class="text-muted small">Submitted vs Unsubmitted</span>
    </div>
    <div style="height: 320px;">
      <canvas id="submissionBarChart"></canvas>
    </div>
  </div>
  {% endif %}

  {# ==== student at risk ==== #}
  <div class="card-elevated mb-3">
      {% if role == "wellbeing" %}
       <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0">
        Students to contact (wellbeing risk)
      </h6>
      <span class="text-muted small">
        Auto-flagged based on recent stress / attendance / submissions.
      </span>
    </div>
     {% if students_to_contact %}
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>Student ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Reason</th>
              <th>Details</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for s in students_to_contact %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ s.student_id }}</td>
              <td>{{ s.name }}</td>
              <td>{{ s.email }}</td>
              <td>{{ s.reason }}</td>
              <td>{{ s.detail }}</td>
              <td>
                <a class="btn btn-sm btn-outline-primary"
                  href="{{ url_for('view_data', role=role, data_type='wellbeing') }}">
                  View record
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted small mb-0">
        No students currently flagged for follow-up in the selected period.
      </p>
      {% endif %}

    {% elif role == "course_leader" %}
      {# --- Attendance risk --- #}
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Students to contact (attendance risk)</h6>
        <span class="text-muted small">
          Low attendance over selected weeks.
        </span>
      </div>
      {% if attendance_risk_students %}
      <div class="table-responsive mb-3">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>Module</th>
              <th>Student ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Attendance rate</th>
              <th>Absent sessions</th>
            </tr>
          </thead>
          <tbody>
            {% for s in attendance_risk_students %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ s.module_code }}</td>
              <td>{{ s.student_id }}</td>
              <td>{{ s.name }}</td>
              <td>{{ s.email }}</td>
              <td>{{ (s.attendance_rate * 100)|round(1) }}%</td>
              <td>{{ s.absent_sessions }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted small">
        No students with low attendance in the selected range.
      </p>
       {% endif %}
      {# --- submission risk  --- #}
      <div class="d-flex justify-content-between align-items-center mb-2 mt-4">
        <h6 class="mb-0">Students to contact (submission risk)</h6>
        <span class="text-muted small">
          Missing or late submissions.
        </span>
      </div>

        {% if submission_risk_students %}
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Student ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Missing submissions</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {% for s in submission_risk_students %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ s.student_id }}</td>
                <td>{{ s.name }}</td>
                <td>{{ s.email }}</td>
                <td>{{ s.offending_module_count }}</td>
                <td>
                  {# 展开 details：每一门课缺了什么 #}
                  <ul class="mb-0 ps-3">
                    {% for d in s.details %}
                      <li>
                        {{ d.courseId }} – {{ d.courseName }}
                        (Assignment {{ d.assignmentNo }}, {{ d.status }})
                      </li>
                    {% endfor %}
                  </ul>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted small mb-0">
          No students with submission issues in the selected range.
        </p>
        {% endif %}
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  const ROLE = {{ role| tojson }};

  const weeks = {{ weeks_for_chart| tojson }};
  const avgStress = {{ avg_stress| tojson }};
  const avgSleep = {{ avg_sleep| tojson }};
  const attendanceTrend = {{ attendance_trend| tojson }};
  const gradeTrend = {{ grade_trend| tojson }};

  console.log("ROLE =", ROLE);
  console.log("weeks =", weeks);
  console.log("avgStress =", avgStress);
  console.log("avgSleep =", avgSleep);
  console.log("attendanceTrend =", attendanceTrend);
  console.log("gradeTrend =", gradeTrend);

  function renderLineChart(canvasId, labels, datasets) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { title: { display: true, text: 'Week' } },
          y: { title: { display: true, text: 'Value' } }
        },
        plugins: {
          legend: { display: true },
          tooltip: { enabled: true }
        }
      }
    });
  }

  // ========= wellbeing 折线图 =========
  if (ROLE === "wellbeing" && weeks.length > 0) {
    renderLineChart("lineChartWellbeing", weeks, [
      {
        label: "Avg Stress (1–5)",
        data: avgStress,
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 3,
      },
      {
        label: "Avg Sleep (hours)",
        data: avgSleep,
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 3,
      }
    ]);
  }

  // ========= course_leader 折线图 =========
  if (ROLE === "course_leader" && weeks.length > 0) {
    renderLineChart("lineChartCourse", weeks, [
      {
        label: "Attendance Rate (%)",
        data: attendanceTrend.map(x => x * 100),  // 0.8 -> 80
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 3,
      }
    ]);
  }
  // ========== Submission Chart ==========
  const subLabels = {{ submission_labels | default ([], true) | tojson }};
  const subSubmitted = {{ submission_submitted | default ([], true) | tojson }};
  const subUnsubmitted = {{ submission_unsubmitted | default ([], true) | tojson }};

  console.log("subLabels =", subLabels);
  console.log("subSubmitted =", subSubmitted);
  console.log("subUnsubmitted =", subUnsubmitted);

  const subCtx = document.getElementById('submissionBarChart');
  if (subCtx) {
    new Chart(subCtx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: subLabels,   // X 轴：每个 module
        datasets: [
          {
            label: 'Submitted',
            data: subSubmitted,
            borderWidth: 1,
          },
          {
            label: 'Unsubmitted',
            data: subUnsubmitted,
            borderWidth: 1,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            stacked: false
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Number of students' }
          }
        },
        plugins: {
          tooltip: { enabled: true },
          legend: { display: true }
        }
      }
    });
  }
</script>

{% if role == 'course_leader' %}
<script>
  // 从后端传来的映射
  const MODULES_BY_PROGRAMME = {{ modules_by_programme | tojson }};
  const CURRENT_PROGRAMME = {{ current_programme | tojson }};
  let CURRENT_MODULE = {{ current_module | tojson }};

  console.log("MODULES_BY_PROGRAMME =", MODULES_BY_PROGRAMME);

  function updateModuleOptions(programmeId) {
    const moduleSelect = document.getElementById("module-select");
    if (!moduleSelect) return;

    // programme 未选 → 禁用
    if (!programmeId || !MODULES_BY_PROGRAMME[programmeId]) {
      moduleSelect.innerHTML = "<option value=''>Select programme first</option>";
      moduleSelect.disabled = true;
      return;
    }

    // programme 已选 → 填充 module
    const moduleList = MODULES_BY_PROGRAMME[programmeId] || [];
    moduleSelect.disabled = false;

    moduleSelect.innerHTML = "";

    // ALL modules
    const allOpt = document.createElement("option");
    allOpt.value = "";
    allOpt.textContent = "All modules";
    if (!CURRENT_MODULE) allOpt.selected = true;
    moduleSelect.appendChild(allOpt);

    // append modules
    moduleList.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = `${m.code} – ${m.name}`;
      if (m.id === CURRENT_MODULE) {
        opt.selected = true;
      }
      moduleSelect.appendChild(opt);
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const programmeSelect = document.getElementById("programme-select");
    if (!programmeSelect) return;

    // 初次加载
    updateModuleOptions(CURRENT_PROGRAMME || programmeSelect.value);

    // programme 改变时联动 module
    programmeSelect.addEventListener("change", (e) => {
      CURRENT_MODULE = "";   // 清空旧 module
      updateModuleOptions(e.target.value);
    });
  });
</script>
{% endif %}
{% endblock %}