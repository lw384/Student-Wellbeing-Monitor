{% extends "layout.html" %}
{% set active_page = 'dashboard' %}
{% set simple_layout = False %}

{% block content %}
<div class="main-content">

  {# ==== title ==== #}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="page-title mb-1">
        {% if role == "wellbeing" %}
        Wellbeing Officer Dashboard
        {% else %}
        Course Director Dashboard
        {% endif %}
      </h1>
      <p class="page-subtitle mb-0">
        {% if role == "wellbeing" %}
        Monitor trends in stress, sleep and engagement over recent weeks.
        {% else %}
        Course Director Dashboard
        {% endif %}

      </p>
    </div>

    <div class="text-end d-none d-md-block">
      <a href="{{ url_for('view_data', role=role) }}" class="link-muted d-block">
        View data tables →
      </a>
    </div>
  </div>
  {# ==== filter: Week + Programme (+ Module for course_leader) ==== #}
  <div class="card-elevated mb-3">
    <form class="d-flex flex-wrap align-items-end gap-3" method="get" action="{{ url_for('dashboard', role=role) }}">

      <style>
        .filter-field {
          width: 180px;
        }
      </style>

      {# ---- Start Week ---- #}
      <div class="filter-field">
        <label class="form-label fw-semibold small text-uppercase text-muted mb-1">
          Start Week
        </label>
        <select name="start_week" class="form-select form-select-sm">
          {% for w in weeks %}
          <option value="{{ w }}" {% if w==current_start_week %}selected{% endif %}>
            Week {{ w }}
          </option>
          {% endfor %}
        </select>
      </div>

      {# ---- End Week ---- #}
      <div class="filter-field">
        <label class="form-label fw-semibold small text-uppercase text-muted mb-1">
          End Week
        </label>
        <select name="end_week" class="form-select form-select-sm">
          {% for w in weeks %}
          <option value="{{ w }}" {% if w==current_end_week %}selected{% endif %}>
            Week {{ w }}
          </option>
          {% endfor %}
        </select>
      </div>

      {# ---- Programme ---- #}
      <div class="filter-field">
        <label class="form-label fw-semibold small text-uppercase text-muted mb-1">
          Programme
        </label>
        <select id="programme-select" name="programme_id" class="form-select form-select-sm" {% if role=='course_leader'
          %}required{% endif %}>

          {# wellbeing 可以选全部 #}
          {% if role == 'wellbeing' %}
          <option value="">All programmes</option>

          {# course_leader 必须选一个具体专业，不提供 All；给一个 disabled 占位 #}
          {% elif role == 'course_leader' %}
          <option value="" disabled {% if not current_programme %}selected{% endif %}>
            Select programme...
          </option>
          {% endif %}

          {% for p in programmes %}
          <option value="{{ p.id }}" {% if p.id==current_programme %}selected{% endif %}>
            {{ p.code }} – {{ p.name }}
          </option>
          {% endfor %}
        </select>
      </div>

      {# ---- Module 仅在 course_leader 角色时显示 ---- #}
      {% if role == 'course_leader' %}
      <div class="filter-field">
        <label class="form-label fw-semibold small text-uppercase text-muted mb-1">
          Module
        </label>

        {# ======== Disable until programme selected ======== #}
        <select id="module-select" name="module_code" class="form-select form-select-sm" {% if not current_programme
          %}disabled{% endif %}>

          {% if current_programme %}
          {# ------ programme selected → show All modules ------ #}
          <option value="" {% if not current_module %}selected{% endif %}>
            All modules
          </option>

          {% for m in modules %}
          <option value="{{ m.code }}" {% if m.code==current_module %}selected{% endif %}>
            {{ m.code }} – {{ m.name }}
          </option>
          {% endfor %}

          {% else %}
          {# ------ programme NOT selected → show placeholder ------ #}
          <option value="">Select programme first</option>
          {% endif %}

        </select>
      </div>
      {% endif %}

      {# ---- Apply button ---- #}
      <div class="ms-auto">
        <button type="submit" class="btn btn-primary btn-sm px-4">
          Apply
        </button>
      </div>

    </form>
  </div>
  {# ==== index card: based on roles ==== #}
  {% if role == 'wellbeing' %}

  {# ------- Student Wellbeing Officer ------- #}
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <div class="card-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-uppercase text-muted fw-semibold">
            Avg Hours Slept
          </span>
        </div>
        <div class="d-flex align-items-baseline gap-2">
          <span class="fs-3 fw-semibold">
            {{ summary.avg_sleep|default('--') }}
          </span>
          <span class="text-muted small">hrs / night</span>
        </div>
        <p class="text-muted small mb-0 mt-1">
          Based on selected week & programme.
        </p>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-uppercase text-muted fw-semibold">
            Avg Stress Level
          </span>
        </div>
        <div class="d-flex align-items-baseline gap-2">
          <span class="fs-3 fw-semibold">
            {{ summary.avg_stress|default('--') }}
          </span>
          <span class="text-muted small">/ 5</span>
        </div>
        <p class="text-muted small mb-0 mt-1">
          Higher values may indicate wellbeing risk.
        </p>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-uppercase text-muted fw-semibold">
            Survey Responses
          </span>
        </div>
        <div class="d-flex align-items-baseline gap-2">
          <span class="fs-3 fw-semibold">
            {{ summary.response_count|default('--') }}
          </span>
          <span class="text-muted small">students</span>
        </div>
        <p class="text-muted small mb-0 mt-1">
          Response rate {{ summary.response_rate|default('--') }}%.
        </p>
      </div>
    </div>
  </div>

  {% elif role == 'course_leader' %}

  {# ------- Course Leader ------- #}
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <div class="card-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-uppercase text-muted fw-semibold">
            Avg Attendance Rate
          </span>
        </div>
        <div class="d-flex align-items-baseline gap-2">
          <span class="fs-3 fw-semibold">
            {{ (summary.avg_attendance_rate * 100)|round(1)|default('--') }}
          </span>
          <span class="text-muted small">%</span>
        </div>
        <p class="text-muted small mb-0 mt-1">
          Across selected weeks & modules.
        </p>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-uppercase text-muted fw-semibold">
            Avg Submission Rate
          </span>
        </div>
        <div class="d-flex align-items-baseline gap-2">
          <span class="fs-3 fw-semibold">
            {{ (summary.avg_submission_rate * 100)|round(1)|default('--') }}
          </span>
          <span class="text-muted small">%</span>
        </div>
        <p class="text-muted small mb-0 mt-1">
          Proportion of submitted assignments.
        </p>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-uppercase text-muted fw-semibold">
            Avg Grade
          </span>
        </div>
        <div class="d-flex align-items-baseline gap-2">
          <span class="fs-3 fw-semibold">
            {{ summary.avg_grade|round(1)|default('--') }}
          </span>
          <span class="text-muted small">/ 100</span>
        </div>
        <p class="text-muted small mb-0 mt-1">
          Based on submitted assignments only.
        </p>
      </div>
    </div>
  </div>

  {% endif %}

  {# ==== line chart: trend across week(stress/sleep/response) ==== #}
  {% if role == 'wellbeing' %}
  <div class="card-elevated mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0">Stress & Sleep over weeks</h6>
      <span class="text-muted small">Average values per week</span>
    </div>
    <div style="height: 320px;">
      <canvas id="lineChart"></canvas>
    </div>
  </div>
  {% endif %}

  {# ==== 柱状图：按课程的出勤率 / 成绩 ==== #}
  {% if role == 'course_leader' %}
  <div class="card-elevated mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0">Attendance Rate by Module</h6>
      <span class="text-muted small">0–100% attendance</span>
    </div>
    <div style="height: 320px;">
      <canvas id="barChart"></canvas>
    </div>
  </div>
  {% endif %}

  {# ==== student at risk ==== #}
  <div class="card-elevated mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0">
        {% if role == "wellbeing" %}
        Students to contact (wellbeing risk)
        {% else %}
        Students to contact (engagement risk)
        {% endif %}
      </h6>
      <span class="text-muted small">
        Auto-flagged based on recent stress / attendance / submissions.
      </span>
    </div>

    {% if students_to_contact %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>Student ID</th>
            <th>Name</th>
            <th>Reason</th>
            <th>Details</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for s in students_to_contact %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ s.student_id }}</td>
            <td>{{ s.name }}</td>
            <td>{{ s.reason }}</td>
            <td>{{ s.detail }}</td>
            <td>
              <!-- <a class="btn btn-sm btn-outline-primary"
                     href="{{ url_for('view_data', role=role, data_type='wellbeing') }}">
                    View record
                  </a> -->
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted small mb-0">
      No students currently flagged for follow-up in the selected period.
    </p>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // 从后端传来的数据（Python list -> JS array）
  const weeks = {{ weeks_for_chart| tojson }};
  const avgStress = {{ avg_stress| tojson }};
  const avgSleep = {{ avg_sleep| tojson }};
  // const programme     = {{ modules_for_chart|tojson }};
  const attRate = {{ attendance_rate| tojson }};

  console.log("weeks =", weeks);
  console.log("avgStress =", avgStress);
  console.log("avgSleep =", avgSleep);
  // console.log("modules =", modules);
  console.log("attRate =", attRate);
  // ========= 折线图 =========
  const lineCtx = document.getElementById('lineChart').getContext('2d');
  new Chart(lineCtx, {
    type: 'line',
    data: {
      labels: weeks,
      datasets: [
        {
          label: 'Avg Stress (1–5)',
          data: avgStress,
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 3,
        },
        {
          label: 'Avg Sleep (hours)',
          data: avgSleep,
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 3,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { title: { display: true, text: 'Week' } },
        y: { title: { display: true, text: 'Value' } }
      },
      plugins: {
        legend: { display: true },
        tooltip: { enabled: true }
      }
    }
  });

  // ========= 柱状图 =========
  const barCtx = document.getElementById('barChart').getContext('2d');
  new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: modules,
      datasets: [
        {
          label: 'Attendance rate (%)',
          data: attRate.map(x => x * 100),  // 0.85 -> 85
          borderWidth: 1,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: 'Attendance %' }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => ctx.parsed.y.toFixed(1) + '%'
          }
        }
      }
    }
  });
</script>

<script>
const modules = {{ modules_for_chart | tojson }};
</script>

{% if role == 'course_leader' %}
<script>
  // 从后端传来的映射
  const MODULES_BY_PROGRAMME = {{ modules_by_programme | tojson }};
  const CURRENT_PROGRAMME = {{ current_programme | tojson }};
  let CURRENT_MODULE = {{ current_module | tojson }};

  console.log("MODULES_BY_PROGRAMME =", MODULES_BY_PROGRAMME);

  function updateModuleOptions(programmeId) {
    const moduleSelect = document.getElementById("module-select");
    if (!moduleSelect) return;

    // programme 未选 → 禁用
    if (!programmeId || !MODULES_BY_PROGRAMME[programmeId]) {
      moduleSelect.innerHTML = "<option value=''>Select programme first</option>";
      moduleSelect.disabled = true;
      return;
    }

    // programme 已选 → 填充 module
    const moduleList = MODULES_BY_PROGRAMME[programmeId] || [];
    moduleSelect.disabled = false;

    moduleSelect.innerHTML = "";

    // ALL modules
    const allOpt = document.createElement("option");
    allOpt.value = "";
    allOpt.textContent = "All modules";
    if (!CURRENT_MODULE) allOpt.selected = true;
    moduleSelect.appendChild(allOpt);

    // append modules
    moduleList.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.code;
      opt.textContent = `${m.code} – ${m.name}`;
      if (m.code === CURRENT_MODULE) {
        opt.selected = true;
      }
      moduleSelect.appendChild(opt);
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const programmeSelect = document.getElementById("programme-select");
    if (!programmeSelect) return;

    // 初次加载
    updateModuleOptions(CURRENT_PROGRAMME || programmeSelect.value);

    // programme 改变时联动 module
    programmeSelect.addEventListener("change", (e) => {
      CURRENT_MODULE = "";   // 清空旧 module
      updateModuleOptions(e.target.value);
    });
  });
</script>
{% endif %}
{% endblock %}